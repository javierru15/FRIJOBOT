<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FRIJOBOT</title>
  <meta name="description" content="FRIJOBOT â€” Asistente inteligente conectado a tu operaciÃ³n." />
  <meta name="theme-color" content="#06140C" />

  <style>
    :root{
      /* TraxiÃ³n-ish: deep black/green + premium glass */
      --bg0:#050807;
      --bg1:#06140C;
      --panel:#0A1A12;
      --panel2:#08130D;

      --card: rgba(255,255,255,.05);
      --card2: rgba(255,255,255,.08);

      --border: rgba(255,255,255,.10);
      --border2: rgba(255,255,255,.18);

      --text:#EAF7F0;
      --muted:#A7B8AE;

      --brand:#22C55E;
      --brand2:#16A34A;
      --danger:#EF4444;
      --warn:#F59E0B;

      --shadow: 0 24px 70px rgba(0,0,0,.55);
      --shadow2: 0 12px 34px rgba(0,0,0,.45);

      --r: 18px;
      --r2: 22px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(900px 560px at 14% 10%, rgba(34,197,94,.18), transparent 60%),
        radial-gradient(900px 520px at 86% 6%, rgba(34,197,94,.10), transparent 55%),
        radial-gradient(1100px 820px at 50% 100%, rgba(255,255,255,.07), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* Soft grain */
    body:before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='160' height='160' filter='url(%23n)' opacity='.18'/%3E%3C/svg%3E");
      opacity:.10;
      mix-blend-mode: overlay;
    }

    /* Container */
    .wrap{
      width:min(1280px, 100%);
      margin:0 auto;
      padding: 18px 16px 26px;
    }

    /* Header */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding: 12px 14px;
      border-radius: var(--r2);
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(8,19,13,.78), rgba(8,19,13,.48));
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow2);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }

    .logoWrap{
      width:46px; height:46px;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(34,197,94,.30);
      background: linear-gradient(135deg, rgba(34,197,94,.25), rgba(255,255,255,.06));
      box-shadow: 0 18px 45px rgba(34,197,94,.10);
      display:grid;
      place-items:center;
      flex:0 0 auto;
    }
    .logoWrap img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .brandText{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brandText .title{
      font-weight: 950;
      letter-spacing:.5px;
      text-transform: uppercase;
      font-size: 14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandText .subtitle{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .rightTop{
      display:flex;
      align-items:center;
      gap:10px;
      flex:0 0 auto;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      backdrop-filter: blur(10px);
      font-size: 12px;
      color: var(--muted);
      box-shadow: 0 10px 28px rgba(0,0,0,.35);
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: var(--danger);
      box-shadow: 0 0 0 4px rgba(239,68,68,.14);
    }
    .dot.ok{
      background: var(--brand);
      box-shadow: 0 0 0 4px rgba(34,197,94,.16);
    }

    .btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 850;
      cursor:pointer;
      transition: .15s transform, .15s background, .15s border, .15s box-shadow;
      box-shadow: 0 10px 28px rgba(0,0,0,.25);
    }
    .btn:hover{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 14px 34px rgba(0,0,0,.35);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(34,197,94,.36);
      background: linear-gradient(135deg, rgba(34,197,94,.20), rgba(255,255,255,.06));
    }

    /* App layout */
    .shell{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 14px;
      align-items: stretch;
    }

    @media (max-width: 980px){
      .shell{ grid-template-columns: 1fr; }
      .sidebar{ order: 2; }
      .main{ order: 1; }
    }

    /* Panels */
    .panel{
      border-radius: var(--r2);
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height: 580px;
    }

    /* Sidebar */
    .sidebarHeader{
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(8,19,13,.92), rgba(8,19,13,.60));
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .sidebarHeader .h{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .sidebarHeader .h .t{
      font-weight:950;
      text-transform:uppercase;
      font-size: 12.5px;
      letter-spacing:.4px;
    }
    .sidebarHeader .h .s{
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .iconBtn{
      width:38px;
      height:38px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--text);
      cursor:pointer;
      display:grid;
      place-items:center;
      font-weight: 900;
      transition:.15s background,.15s border;
    }
    .iconBtn:hover{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.18);
    }

    .sideBody{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .search{
      width:100%;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 10px 12px;
      color: var(--text);
      outline:none;
      font-size: 13px;
    }
    .search::placeholder{ color: rgba(167,184,174,.75); }

    .chatList{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: 520px;
      overflow:auto;
      padding-right: 4px;
    }

    .chatItem{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius: 18px;
      padding: 10px 10px;
      cursor:pointer;
      transition: .15s background, .15s border, .15s transform;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .chatItem:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.18);
      transform: translateY(-1px);
    }
    .chatItem.active{
      border-color: rgba(34,197,94,.34);
      background: linear-gradient(135deg, rgba(34,197,94,.14), rgba(255,255,255,.03));
    }

    .chatItem .meta{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .chatItem .name{
      font-weight: 950;
      font-size: 13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chatItem .snippet{
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 250px;
    }
    .chatItem .when{
      font-size:11px;
      color: rgba(167,184,174,.85);
    }
    .miniBtns{
      display:flex;
      flex-direction:column;
      gap:6px;
      flex:0 0 auto;
    }

    /* Main */
    .main{
      display:grid;
      grid-template-rows: auto 1fr auto;
    }

    .mainHeader{
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(8,19,13,.92), rgba(8,19,13,.60));
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .mainHeader .left{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .mainHeader .left .t{
      font-weight: 950;
      text-transform: uppercase;
      letter-spacing:.45px;
      font-size: 12.5px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .mainHeader .left .s{
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .codePill{
      font-family: var(--mono);
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: #DFF7E7;
    }

    .chatBox{
      padding: 14px;
      overflow:auto;
      background:
        radial-gradient(1200px 720px at 50% 0%, rgba(34,197,94,.08), transparent 55%),
        rgba(10,15,20,.30);
    }

    .msgRow{
      display:flex;
      gap:10px;
      margin: 10px 0;
      align-items:flex-start;
    }

    .avatar{
      width: 38px; height: 38px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      display:grid;
      place-items:center;
      font-weight: 950;
      color: var(--muted);
      flex: 0 0 auto;
      user-select:none;
    }
    .avatar.user{
      border-color: rgba(34,197,94,.26);
      color: #C9FBD8;
      background: rgba(34,197,94,.08);
    }
    .avatar.bot{
      border-color: rgba(255,255,255,.14);
      color: #EAF7F0;
    }

    .bubble{
      max-width: 860px;
      padding: 12px 12px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      white-space:pre-wrap;
      word-break:break-word;
      line-height:1.35;
    }
    .bubble.user{
      border-color: rgba(34,197,94,.22);
      background: rgba(34,197,94,.10);
    }
    .bubble.bot{
      border-color: rgba(255,255,255,.12);
    }

    .time{
      margin-top: 6px;
      font-size: 11px;
      color: rgba(167,184,174,.86);
    }

    .typing{
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    .typing span{
      width:7px; height:7px; border-radius:99px;
      background: rgba(255,255,255,.42);
      animation: bounce 1s infinite ease-in-out;
    }
    .typing span:nth-child(2){ animation-delay:.12s }
    .typing span:nth-child(3){ animation-delay:.24s }
    @keyframes bounce{
      0%,80%,100%{ transform: translateY(0); opacity:.55 }
      40%{ transform: translateY(-6px); opacity:1 }
    }

    .composer{
      padding: 12px 14px 14px;
      border-top: 1px solid var(--border);
      background: linear-gradient(0deg, rgba(8,19,13,.92), rgba(8,19,13,.60));
      display:flex;
      gap: 10px;
      align-items:flex-end;
    }
    textarea{
      width:100%;
      min-height: 48px;
      max-height: 160px;
      resize:none;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 12px 12px;
      outline:none;
      font-size: 14px;
      line-height: 1.25;
    }
    textarea::placeholder{ color: rgba(167,184,174,.75); }

    .footNote{
      padding: 10px 14px 12px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      border-top: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.08);
    }
    a.link{
      color: #C9FBD8;
      text-decoration:none;
      border-bottom: 1px dashed rgba(201,251,216,.55);
    }

    /* Scrollbars (nice) */
    .chatBox::-webkit-scrollbar,
    .chatList::-webkit-scrollbar{
      width: 10px;
    }
    .chatBox::-webkit-scrollbar-thumb,
    .chatList::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.10);
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.2);
    }
    .chatBox::-webkit-scrollbar-thumb:hover,
    .chatList::-webkit-scrollbar-thumb:hover{
      background: rgba(255,255,255,.16);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Header -->
    <div class="topbar">
      <div class="brand">
        <div class="logoWrap" title="FRIJOBOT">
          <!-- Logo file must exist in repo root: logo.png -->
          <img src="logo.png" alt="Logo FRIJOBOT"
               onerror="this.style.display='none'; this.parentElement.style.background='linear-gradient(135deg, rgba(34,197,94,.22), rgba(255,255,255,.06))';" />
        </div>
        <div class="brandText">
          <div class="title">FRIJOBOT</div>
          <div class="subtitle">TraxiÃ³n Â· Vida en movimiento Â· Asistente para operaciÃ³n y datos</div>
        </div>
      </div>

      <div class="rightTop">
        <div class="pill" title="Estado de conexiÃ³n">
          <span class="dot" id="statusDot"></span>
          <span id="statusText">Sin conectar</span>
        </div>
        <button class="btn" id="newChatBtn">Nuevo chat</button>
        <button class="btn primary" id="clearAllBtn">Limpiar todo</button>
      </div>
    </div>

    <!-- App -->
    <div class="shell">
      <!-- Sidebar -->
      <aside class="panel sidebar">
        <div class="sidebarHeader">
          <div class="h">
            <div class="t">Conversaciones</div>
            <div class="s">Guardadas en este navegador</div>
          </div>
          <button class="iconBtn" id="exportBtn" title="Exportar historial">â¤“</button>
        </div>

        <div class="sideBody">
          <input class="search" id="search" placeholder="Buscar conversaciÃ³n..." />
          <div class="chatList" id="chatList"></div>
        </div>
      </aside>

      <!-- Main -->
      <main class="panel main">
        <div class="mainHeader">
          <div class="left">
            <div class="t" id="chatTitle">Chat</div>
            <div class="s">
              Tip: Enter envÃ­a Â· Shift+Enter salto Â· Endpoint <span class="codePill">/webhook/chat</span>
            </div>
          </div>
          <button class="btn" id="clearChatBtn">Limpiar chat</button>
        </div>

        <div class="chatBox" id="chatBox"></div>

        <div class="footNote">
          <div>Evita compartir informaciÃ³n sensible innecesaria.</div>
          <div><a href="#" class="link" id="privacy">Aviso</a></div>
        </div>

        <div class="composer">
          <textarea id="input" placeholder="Escribe tu preguntaâ€¦"></textarea>
          <button class="btn primary" id="sendBtn">Enviar</button>
        </div>
      </main>
    </div>
  </div>

<script>
  // =========================
  // CONFIG
  // =========================
  const WEBHOOK_URL = "https://auto.mindtrax.io/webhook/chat";
  const STORE_KEY = "frijobot_store_v2"; // bump version

  function uid(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function nowStr(){
    const d = new Date();
    return d.toLocaleString([], { day:"2-digit", month:"short", hour:"2-digit", minute:"2-digit" });
  }

  function loadStore(){
    try{
      return JSON.parse(localStorage.getItem(STORE_KEY)) || { activeId: null, chats: [] };
    }catch{
      return { activeId: null, chats: [] };
    }
  }

  function saveStore(store){
    localStorage.setItem(STORE_KEY, JSON.stringify(store));
  }

  function createChat(name="Chat"){
    return {
      id: uid(),
      name,
      createdAt: Date.now(),
      updatedAt: Date.now(),
      messages: [
        { role: "bot", text: "Hola ðŸ‘‹ Soy FRIJOBOT. Â¿QuÃ© quieres analizar hoy?", ts: Date.now() }
      ]
    };
  }

  // DOM
  const chatList = document.getElementById("chatList");
  const chatBox  = document.getElementById("chatBox");
  const input    = document.getElementById("input");
  const sendBtn  = document.getElementById("sendBtn");
  const clearChatBtn = document.getElementById("clearChatBtn");
  const clearAllBtn  = document.getElementById("clearAllBtn");
  const newChatBtn   = document.getElementById("newChatBtn");
  const exportBtn    = document.getElementById("exportBtn");
  const search       = document.getElementById("search");
  const chatTitle    = document.getElementById("chatTitle");
  const statusDot    = document.getElementById("statusDot");
  const statusText   = document.getElementById("statusText");

  function setStatus(ok, text){
    statusDot.classList.toggle("ok", !!ok);
    statusText.textContent = text;
  }

  function escapeText(t){ return (t ?? "").toString(); }

  function renderMessage(msg){
    const row = document.createElement("div");
    row.className = "msgRow";

    const avatar = document.createElement("div");
    avatar.className = "avatar " + (msg.role === "user" ? "user" : "bot");
    avatar.textContent = msg.role === "user" ? "TÃº" : "F";

    const bubble = document.createElement("div");
    bubble.className = "bubble " + (msg.role === "user" ? "user" : "bot");
    bubble.textContent = escapeText(msg.text);

    const time = document.createElement("div");
    time.className = "time";
    time.textContent = new Date(msg.ts).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});

    const col = document.createElement("div");
    col.appendChild(bubble);
    col.appendChild(time);

    row.appendChild(avatar);
    row.appendChild(col);
    return row;
  }

  function renderTyping(){
    const row = document.createElement("div");
    row.className = "msgRow";

    const avatar = document.createElement("div");
    avatar.className = "avatar bot";
    avatar.textContent = "F";

    const bubble = document.createElement("div");
    bubble.className = "bubble bot";
    bubble.innerHTML = `<span class="typing"><span></span><span></span><span></span></span>`;

    const time = document.createElement("div");
    time.className = "time";
    time.textContent = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});

    const col = document.createElement("div");
    col.appendChild(bubble);
    col.appendChild(time);

    row.appendChild(avatar);
    row.appendChild(col);
    return row;
  }

  function getActiveChat(store){
    return store.chats.find(c => c.id === store.activeId) || null;
  }

  function snippetFromChat(chat){
    const last = chat.messages[chat.messages.length - 1];
    const t = last?.text || "";
    return t.length > 60 ? t.slice(0,60) + "â€¦" : t;
  }

  function renderSidebar(store){
    const q = (search.value || "").trim().toLowerCase();
    chatList.innerHTML = "";

    const chats = [...store.chats].sort((a,b) => b.updatedAt - a.updatedAt)
      .filter(c => !q || c.name.toLowerCase().includes(q) || snippetFromChat(c).toLowerCase().includes(q));

    chats.forEach(chat => {
      const item = document.createElement("div");
      item.className = "chatItem " + (chat.id === store.activeId ? "active" : "");

      const meta = document.createElement("div");
      meta.className = "meta";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = chat.name;

      const snip = document.createElement("div");
      snip.className = "snippet";
      snip.textContent = snippetFromChat(chat);

      const when = document.createElement("div");
      when.className = "when";
      when.textContent = new Date(chat.updatedAt).toLocaleString([], { day:"2-digit", month:"short", hour:"2-digit", minute:"2-digit" });

      meta.appendChild(name);
      meta.appendChild(snip);
      meta.appendChild(when);

      const mini = document.createElement("div");
      mini.className = "miniBtns";

      const renameBtn = document.createElement("button");
      renameBtn.className = "iconBtn";
      renameBtn.title = "Renombrar";
      renameBtn.textContent = "âœŽ";
      renameBtn.onclick = (e)=>{
        e.stopPropagation();
        const n = prompt("Nombre de la conversaciÃ³n:", chat.name);
        if(n && n.trim()){
          chat.name = n.trim();
          chat.updatedAt = Date.now();
          saveStore(store);
          renderAll(store);
        }
      };

      const delBtn = document.createElement("button");
      delBtn.className = "iconBtn";
      delBtn.title = "Eliminar";
      delBtn.textContent = "ðŸ—‘";
      delBtn.onclick = (e)=>{
        e.stopPropagation();
        if(!confirm("Â¿Eliminar esta conversaciÃ³n?")) return;
        store.chats = store.chats.filter(c => c.id !== chat.id);
        if(store.activeId === chat.id){
          store.activeId = store.chats[0]?.id || null;
        }
        if(!store.activeId && store.chats.length === 0){
          const c = createChat("Chat");
          store.chats.push(c);
          store.activeId = c.id;
        }
        saveStore(store);
        renderAll(store);
      };

      mini.appendChild(renameBtn);
      mini.appendChild(delBtn);

      item.appendChild(meta);
      item.appendChild(mini);

      item.onclick = ()=>{
        store.activeId = chat.id;
        saveStore(store);
        renderAll(store);
      };

      chatList.appendChild(item);
    });
  }

  function renderChat(store){
    const chat = getActiveChat(store);
    chatBox.innerHTML = "";
    if(!chat) return;

    chatTitle.textContent = chat.name;

    chat.messages.forEach(m => {
      chatBox.appendChild(renderMessage(m));
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function renderAll(store){
    renderSidebar(store);
    renderChat(store);
  }

  // =========================
  // Reply extraction (HARDENED)
  // Fix: stops printing JSON arrays/objects; extracts real text.
  // =========================
  function extractReply(d){
    // 1) direct strings
    if (typeof d === "string") return d;

    // 2) common keys
    if (d && typeof d.reply === "string") return d.reply;
    if (d && typeof d.output === "string") return d.output;
    if (d && typeof d.text === "string") return d.text;
    if (d && typeof d.message === "string") return d.message;

    // 3) arrays: n8n often returns [{ output: "..." }]
    if (Array.isArray(d)){
      if (d.length === 0) return "Sin respuesta.";
      const first = d[0];
      if (typeof first === "string") return first;
      if (first?.reply) return first.reply;
      if (first?.output) return first.output;
      if (first?.text) return first.text;
      if (first?.message) return first.message;

      // If array of objects but not sure:
      // try to find any string field
      for (const item of d){
        if (!item || typeof item !== "object") continue;
        for (const k of ["reply","output","text","message","answer","result"]){
          if (typeof item[k] === "string") return item[k];
        }
      }
      return JSON.stringify(d);
    }

    // 4) nested keys
    if (d && d.data && Array.isArray(d.data)){
      const x = d.data[0];
      if (x?.reply) return x.reply;
      if (x?.output) return x.output;
      if (x?.text) return x.text;
      if (x?.message) return x.message;
    }

    // 5) if response contains { output: [ { ... } ] } etc.
    if (d && typeof d === "object"){
      for (const k of ["reply","output","text","message","answer","result"]){
        if (typeof d[k] === "string") return d[k];
        if (Array.isArray(d[k])) return extractReply(d[k]);
        if (d[k] && typeof d[k] === "object") {
          const maybe = extractReply(d[k]);
          if (maybe && typeof maybe === "string") return maybe;
        }
      }
    }

    return JSON.stringify(d);
  }

  // =========================
  // Messaging
  // =========================
  async function send(){
    const text = (input.value || "").trim();
    if(!text) return;

    const store = loadStore();
    const chat = getActiveChat(store);
    if(!chat) return;

    chat.messages.push({ role:"user", text, ts: Date.now() });
    chat.updatedAt = Date.now();
    input.value = "";
    saveStore(store);
    renderAll(store);

    const typingNode = renderTyping();
    chatBox.appendChild(typingNode);
    chatBox.scrollTop = chatBox.scrollHeight;

    try{
      // stable per chat
      const sessionId = chat.id;

      const res = await fetch(WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ message: text, sessionId })
      });

      if(!res.ok){
        const t = await res.text();
        throw new Error(`HTTP ${res.status}: ${t}`);
      }

      const data = await res.json();
      const reply = extractReply(data);

      typingNode.remove();

      chat.messages.push({ role:"bot", text: reply, ts: Date.now() });
      chat.updatedAt = Date.now();
      saveStore(store);

      setStatus(true, "Conectado");
      renderAll(store);
    }catch(err){
      typingNode.remove();
      chat.messages.push({
        role:"bot",
        text: "âš ï¸ No pude conectar con n8n. Si a veces sÃ­ conecta, casi siempre es CORS o el webhook no estÃ¡ activo (producciÃ³n).",
        ts: Date.now()
      });
      chat.updatedAt = Date.now();
      saveStore(store);

      setStatus(false, "Error");
      renderAll(store);
      console.error(err);
    }
  }

  // Buttons / events
  sendBtn.addEventListener("click", send);
  input.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });

  clearChatBtn.addEventListener("click", ()=>{
    const store = loadStore();
    const chat = getActiveChat(store);
    if(!chat) return;
    if(!confirm("Â¿Limpiar esta conversaciÃ³n?")) return;

    chat.messages = [{ role:"bot", text:"Listo. Â¿QuÃ© quieres analizar ahora?", ts: Date.now() }];
    chat.updatedAt = Date.now();
    saveStore(store);
    renderAll(store);
  });

  clearAllBtn.addEventListener("click", ()=>{
    if(!confirm("Â¿Borrar TODAS las conversaciones?")) return;
    const store = { activeId: null, chats: [] };
    const c = createChat("Chat");
    store.chats.push(c);
    store.activeId = c.id;
    saveStore(store);
    renderAll(store);
  });

  newChatBtn.addEventListener("click", ()=>{
    const store = loadStore();
    const c = createChat("Chat " + nowStr());
    store.chats.push(c);
    store.activeId = c.id;
    saveStore(store);
    renderAll(store);
  });

  exportBtn.addEventListener("click", ()=>{
    const store = loadStore();
    const blob = new Blob([JSON.stringify(store, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "frijobot_history.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  search.addEventListener("input", ()=>{
    const store = loadStore();
    renderSidebar(store);
  });

  document.getElementById("privacy").addEventListener("click", (e)=>{
    e.preventDefault();
    alert("FRIJOBOT procesa tus mensajes para responder con datos. Evita compartir informaciÃ³n sensible si no es necesario.");
  });

  // Init
  (function init(){
    let store = loadStore();
    if(!store.chats || store.chats.length === 0){
      const c = createChat("Chat");
      store = { activeId: c.id, chats: [c] };
      saveStore(store);
    }else if(!store.activeId){
      store.activeId = store.chats[0].id;
      saveStore(store);
    }
    renderAll(store);
    setStatus(false, "Sin conectar");
  })();
</script>
</body>
</html>
