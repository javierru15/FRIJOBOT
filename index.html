<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FRIJOBOT</title>
  <meta name="description" content="FRIJOBOT ‚Äî Asistente inteligente conectado a tu operaci√≥n." />

  <style>
    :root{
      --bg:#07120d;
      --bg2:#050f0b;
      --panel:rgba(255,255,255,.04);
      --panel2:rgba(255,255,255,.06);
      --text:#eafff6;
      --muted:#a6c6b7;
      --border:rgba(255,255,255,.10);
      --shadow: 0 20px 70px rgba(0,0,0,.55);

      --g1:#22c55e; /* green */
      --g2:#10b981; /* emerald */
      --g3:#14b8a6; /* teal */

      --danger:#ff4d6d;
      --ok:#34d399;

      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(34,197,94,.22), transparent 55%),
        radial-gradient(900px 500px at 85% 20%, rgba(16,185,129,.18), transparent 60%),
        radial-gradient(900px 700px at 45% 90%, rgba(20,184,166,.12), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      display:flex;
      justify-content:center;
      padding:20px;
    }

    .shell{
      width:min(1200px, 100%);
      height:min(86vh, 820px);
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:14px;
    }

    /* Sidebar */
    .side{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius: calc(var(--radius) + 6px);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .sideHeader{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      backdrop-filter: blur(10px);
    }
    .brandRow{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo{
      width:44px; height:44px;
      border-radius:14px;
      border:1px solid rgba(34,197,94,.35);
      background: linear-gradient(135deg, rgba(34,197,94,.25), rgba(20,184,166,.18));
      overflow:hidden;
      display:grid;
      place-items:center;
      flex:0 0 auto;
      box-shadow: 0 12px 30px rgba(34,197,94,.12);
    }
    .logo img{width:100%;height:100%;object-fit:cover;display:block}
    .titles{min-width:0}
    .titles h1{
      margin:0;
      font-size:14px;
      letter-spacing:.7px;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .titles p{
      margin:2px 0 0;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .sideActions{
      margin-top:10px;
      display:flex;
      gap:8px;
    }

    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      cursor:pointer;
      transition:.15s transform, .15s background, .15s border-color;
      font-weight:800;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      width:100%;
    }
    .btn:hover{ background: rgba(255,255,255,.06); border-color: rgba(34,197,94,.28); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(34,197,94,.22), rgba(20,184,166,.18));
      border-color: rgba(34,197,94,.30);
    }

    .search{
      margin-top:10px;
      display:flex;
      gap:8px;
    }
    .search input{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      outline:none;
      background: rgba(255,255,255,.03);
      color: var(--text);
      font-size:13px;
    }

    .chatList{
      padding:10px;
      overflow:auto;
      min-height:0;
    }
    .chatItem{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px 10px;
      cursor:pointer;
      transition:.15s background, .15s border-color;
      margin-bottom:8px;
    }
    .chatItem:hover{ background: rgba(255,255,255,.05); border-color: rgba(34,197,94,.20); }
    .chatItem.active{
      border-color: rgba(34,197,94,.45);
      background: rgba(34,197,94,.08);
    }
    .chatItem .t{
      font-weight:900;
      font-size:13px;
      margin-bottom:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chatItem .s{
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .sideFooter{
      padding:10px 12px;
      border-top:1px solid var(--border);
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .pill{
      font-size:12px;
      padding:7px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      color:var(--muted);
      background: rgba(255,255,255,.04);
      display:flex; gap:8px; align-items:center;
    }
    .dot{
      width:8px; height:8px; border-radius:99px;
      background: var(--danger);
      box-shadow: 0 0 0 4px rgba(255,77,109,.12);
    }
    .dot.ok{
      background: var(--ok);
      box-shadow: 0 0 0 4px rgba(52,211,153,.14);
    }

    /* Main */
    .main{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius: calc(var(--radius) + 6px);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:grid;
      grid-template-rows:auto 1fr auto;
      min-height:0;
    }
    .mainHeader{
      padding:14px 14px 12px;
      /* header m√°s premium */
      background: linear-gradient(180deg, rgba(34,197,94,.10), rgba(255,255,255,.02));
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .mainHeader .left{
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .mainHeader .left .h{
      font-weight:1000;
      letter-spacing:.4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .mainHeader .left .p{
      color:var(--muted);
      font-size:12px;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .mainHeader .right{
      display:flex;
      gap:8px;
      flex:0 0 auto;
    }
    .btnSmall{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      border-radius:12px;
      padding:9px 10px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
    }
    .btnSmall:hover{ background: rgba(255,255,255,.06); border-color: rgba(34,197,94,.28); }

    .chat{
      overflow:auto;
      padding:14px;
      background: rgba(0,0,0,.18);
      min-height:0;
    }
    .msg{
      display:flex;
      gap:10px;
      margin:10px 0;
      align-items:flex-start;
    }
    .avatar{
      width:34px; height:34px;
      border-radius:12px;
      background: rgba(255,255,255,.05);
      border:1px solid var(--border);
      display:grid; place-items:center;
      flex:0 0 auto;
      color:var(--muted);
      font-weight:1000;
      user-select:none;
    }
    .avatar.user{ color:#b9ffe0; border-color: rgba(34,197,94,.22); }
    .avatar.bot{ color:#b7fff3; border-color: rgba(20,184,166,.22); }
    .bubble{
      max-width: 820px;
      padding:12px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      line-height:1.35;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .bubble.user{
      background: rgba(34,197,94,.07);
      border-color: rgba(34,197,94,.18);
    }
    .bubble.bot{
      background: rgba(20,184,166,.07);
      border-color: rgba(20,184,166,.18);
    }
    .meta{
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
    }
    .typing{
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    .typing span{
      width:7px; height:7px; border-radius:99px;
      background: rgba(234,255,246,.55);
      animation: bounce 1s infinite ease-in-out;
    }
    .typing span:nth-child(2){ animation-delay:.12s }
    .typing span:nth-child(3){ animation-delay:.24s }
    @keyframes bounce{
      0%,80%,100%{ transform: translateY(0); opacity:.55 }
      40%{ transform: translateY(-6px); opacity:1 }
    }

    .composer{
      border-top:1px solid var(--border);
      background: linear-gradient(0deg, rgba(34,197,94,.08), rgba(255,255,255,.02));
      padding:12px 14px 14px;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:flex-end;
    }
    textarea{
      width:100%;
      min-height:46px;
      max-height:160px;
      resize:none;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      outline:none;
      background: rgba(255,255,255,.03);
      color:var(--text);
      font-size:14px;
      line-height:1.25;
    }
    .hint{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .kbd{
      font-family: var(--mono);
      font-size:12px;
      padding:2px 6px;
      border:1px solid var(--border);
      border-radius:10px;
      background: rgba(255,255,255,.03);
      color:#dfffea;
    }
    .toast{
      position:fixed;
      bottom:16px;
      left:50%;
      transform:translateX(-50%);
      background: rgba(2,6,23,.88);
      border:1px solid var(--border);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      box-shadow: var(--shadow);
      font-size:12px;
      display:none;
      gap:8px;
      align-items:center;
      backdrop-filter: blur(10px);
      z-index:50;
    }
    .toast.show{ display:flex; }

    @media (max-width: 980px){
      .shell{ grid-template-columns: 1fr; height:auto; }
      .side{ height:420px; }
      .main{ height:min(86vh, 820px); }
    }
  </style>
</head>

<body>
  <div class="shell">
    <!-- Sidebar -->
    <aside class="side">
      <div class="sideHeader">
        <div class="brandRow">
          <div class="logo" title="Logo">
            <img src="logo.png" alt="Traxi√≥n logo" />
          </div>
          <div class="titles">
            <h1>FRIJOBOT</h1>
            <p>Traxi√≥n ‚Ä¢ Vida en movimiento</p>
          </div>
        </div>

        <div class="sideActions">
          <button class="btn primary" id="newChatBtn">Ôºã Nuevo chat</button>
          <button class="btn" id="deleteChatBtn">üóëÔ∏è Borrar</button>
        </div>

        <div class="search">
          <input id="searchBox" placeholder="Buscar conversaci√≥n‚Ä¶" />
        </div>
      </div>

      <div class="chatList" id="chatList"></div>

      <div class="sideFooter">
        <div class="pill" title="Estado de conexi√≥n">
          <span class="dot" id="statusDot"></span>
          <span id="statusText">Sin conectar</span>
        </div>
        <div>Enter env√≠a ¬∑ Shift+Enter salto</div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="mainHeader">
        <div class="left">
          <div class="h" id="chatTitle">Chat</div>
          <div class="p" id="chatSubtitle">Preg√∫ntame sobre operaci√≥n, siniestros, flota, NPS, MTTO, etc.</div>
        </div>
        <div class="right">
          <button class="btnSmall" id="clearBtn">Limpiar chat</button>
        </div>
      </div>

      <div class="chat" id="chat"></div>

      <div class="composer">
        <div class="row">
          <textarea id="input" placeholder="Escribe tu pregunta‚Ä¶"></textarea>
          <button class="btn primary" style="width:160px" id="sendBtn">Enviar</button>
        </div>
        <div class="hint">
          <div>Tip: <span class="kbd">Enter</span> env√≠a ¬∑ <span class="kbd">Shift+Enter</span> salto de l√≠nea</div>
          <div>Endpoint: <span class="kbd">/webhook/chat</span></div>
        </div>
      </div>
    </main>
  </div>

  <div class="toast" id="toast">
    <span>‚úÖ</span>
    <span id="toastText">Listo</span>
  </div>

<script>
  // =========================
  // CONFIG
  // =========================
  const WEBHOOK_URL = "https://auto.mindtrax.io/webhook/chat";

  // =========================
  // SESSION (por navegador)
  // =========================
  const SESSION_ID = (() => {
    const key = "frijobot_session_id";
    let id = localStorage.getItem(key);
    if (!id) {
      id = (crypto?.randomUUID?.() || ("sid_" + Math.random().toString(16).slice(2) + Date.now()));
      localStorage.setItem(key, id);
    }
    return id;
  })();

  // =========================
  // STORAGE: chats tipo ChatGPT
  // =========================
  const STORE_KEY = "frijobot_chats_v1";
  function loadStore(){
    try{
      return JSON.parse(localStorage.getItem(STORE_KEY) || "null") || { activeId:null, chats:{} };
    }catch{ return { activeId:null, chats:{} }; }
  }
  function saveStore(s){ localStorage.setItem(STORE_KEY, JSON.stringify(s)); }

  function newChat(title="Nuevo chat"){
    const s = loadStore();
    const id = "c_" + (crypto?.randomUUID?.() || (Date.now()+"_"+Math.random().toString(16).slice(2)));
    s.chats[id] = { id, title, updatedAt: Date.now(), messages: [] };
    s.activeId = id;
    saveStore(s);
    return id;
  }

  function getActiveChat(){
    const s = loadStore();
    if (!s.activeId || !s.chats[s.activeId]) {
      const id = newChat("Chat");
      return loadStore().chats[id];
    }
    return s.chats[s.activeId];
  }

  function setActive(id){
    const s = loadStore();
    if (s.chats[id]) { s.activeId = id; saveStore(s); }
  }

  function deleteActive(){
    const s = loadStore();
    const id = s.activeId;
    if (id && s.chats[id]) delete s.chats[id];
    const keys = Object.keys(s.chats);
    s.activeId = keys[0] || null;
    if (!s.activeId) newChat("Chat");
    saveStore(s);
  }

  // =========================
  // UI
  // =========================
  const chatEl = document.getElementById("chat");
  const input = document.getElementById("input");
  const sendBtn = document.getElementById("sendBtn");
  const clearBtn = document.getElementById("clearBtn");
  const newChatBtn = document.getElementById("newChatBtn");
  const deleteChatBtn = document.getElementById("deleteChatBtn");
  const chatListEl = document.getElementById("chatList");
  const searchBox = document.getElementById("searchBox");
  const chatTitle = document.getElementById("chatTitle");
  const chatSubtitle = document.getElementById("chatSubtitle");
  const statusDot = document.getElementById("statusDot");
  const statusText = document.getElementById("statusText");
  const toast = document.getElementById("toast");
  const toastText = document.getElementById("toastText");

  function showToast(text){
    toastText.textContent = text;
    toast.classList.add("show");
    setTimeout(()=>toast.classList.remove("show"), 1400);
  }
  function setStatus(ok, text){
    statusDot.classList.toggle("ok", !!ok);
    statusText.textContent = text;
  }
  function nowTime(){
    const d = new Date();
    return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
  }

  function renderMessages(){
    const c = getActiveChat();
    chatTitle.textContent = c.title || "Chat";
    chatEl.innerHTML = "";
    for (const m of c.messages){
      addMessage(m.role, m.content, m.time, false);
    }
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function addMessage(role, content, timeStr=null, isTyping=false){
    const row = document.createElement("div");
    row.className = "msg";

    const avatar = document.createElement("div");
    avatar.className = "avatar " + (role === "user" ? "user" : "bot");
    avatar.textContent = role === "user" ? "T√∫" : "F";

    const bubble = document.createElement("div");
    bubble.className = "bubble " + (role === "user" ? "user" : "bot");
    bubble.innerHTML = isTyping
      ? `<span class="typing"><span></span><span></span><span></span></span>`
      : "";

    if(!isTyping) bubble.textContent = content;

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = timeStr || nowTime();

    const col = document.createElement("div");
    col.appendChild(bubble);
    col.appendChild(meta);

    row.appendChild(avatar);
    row.appendChild(col);

    chatEl.appendChild(row);
    chatEl.scrollTop = chatEl.scrollHeight;
    return row;
  }

  function renderChatList(){
    const s = loadStore();
    const q = (searchBox.value || "").toLowerCase().trim();
    const chats = Object.values(s.chats)
      .sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0))
      .filter(c => !q || (c.title||"").toLowerCase().includes(q) || (c.messages?.[0]?.content||"").toLowerCase().includes(q));

    chatListEl.innerHTML = "";
    for (const c of chats){
      const item = document.createElement("div");
      item.className = "chatItem" + (c.id === s.activeId ? " active" : "");
      item.innerHTML = `
        <div class="t">${escapeHtml(c.title || "Chat")}</div>
        <div class="s">${escapeHtml((c.messages?.slice(-1)[0]?.content || "Sin mensajes").slice(0,80))}</div>
      `;
      item.addEventListener("click", ()=>{
        setActive(c.id);
        renderChatList();
        renderMessages();
      });
      chatListEl.appendChild(item);
    }
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }

  function pushMessage(role, content){
    const s = loadStore();
    const c = s.chats[s.activeId];
    const timeStr = nowTime();
    c.messages.push({ role, content, time: timeStr });
    c.updatedAt = Date.now();

    // Auto-t√≠tulo con la primera pregunta
    if ((c.title === "Chat" || c.title === "Nuevo chat") && role === "user" && c.messages.length <= 2){
      c.title = content.slice(0, 28) + (content.length > 28 ? "‚Ä¶" : "");
    }

    saveStore(s);
    renderChatList();
  }

  function clearActiveChat(){
    const s = loadStore();
    const c = s.chats[s.activeId];
    c.messages = [];
    c.updatedAt = Date.now();
    saveStore(s);

    addMessage("bot", "Listo. Empecemos de nuevo. ¬øQu√© quieres analizar?");
    pushMessage("bot", "Listo. Empecemos de nuevo. ¬øQu√© quieres analizar?");
    showToast("Chat limpiado");
  }

  // =========================
  // NETWORK
  // =========================
  function extractReply(data){
    // soporta:
    // {reply:"..."}  | {output:"..."} | [{"output":"..."}]
    if (Array.isArray(data) && data.length > 0){
      const x = data[0];
      return x.reply ?? x.output ?? x.text ?? x.message ?? JSON.stringify(x);
    }
    return data.reply ?? data.output ?? data.text ?? data.message ?? JSON.stringify(data);
  }

  async function send(){
    const text = input.value.trim();
    if(!text) return;

    input.value = "";
    addMessage("user", text);
    pushMessage("user", text);

    const typingRow = addMessage("bot", "", null, true);

    try{
      // form-urlencoded para reducir CORS/preflight
      const res = await fetch(WEBHOOK_URL, {
        method:"POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
        body: new URLSearchParams({ message: text, sessionId: SESSION_ID })
      });

      if(!res.ok){
        const t = await res.text();
        throw new Error(`HTTP ${res.status}: ${t}`);
      }

      const data = await res.json();
      const reply = extractReply(data);

      typingRow.querySelector(".bubble").textContent = reply;
      pushMessage("bot", reply);

      setStatus(true, "Conectado");
    }catch(err){
      typingRow.querySelector(".bubble").textContent =
        "‚ö†Ô∏è No pude conectar con n8n. Si esto pasa siempre, es CORS/OPTIONS o el workflow no est√° activo.";
      pushMessage("bot", "‚ö†Ô∏è No pude conectar con n8n.");
      setStatus(false, "Error");
      console.error(err);
    }
  }

  // =========================
  // EVENTS
  // =========================
  input.addEventListener("keydown", (e) => {
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });
  sendBtn.addEventListener("click", send);
  clearBtn.addEventListener("click", clearActiveChat);

  newChatBtn.addEventListener("click", ()=>{
    newChat("Nuevo chat");
    renderChatList();
    renderMessages();
    showToast("Nuevo chat");
  });

  deleteChatBtn.addEventListener("click", ()=>{
    deleteActive();
    renderChatList();
    renderMessages();
    showToast("Chat borrado");
  });

  searchBox.addEventListener("input", renderChatList);

  // =========================
  // INIT
  // =========================
  (function init(){
    const s = loadStore();
    if (!s.activeId || !s.chats[s.activeId]) {
      newChat("Chat");
    }
    // mensaje inicial si est√° vac√≠o
    const c = getActiveChat();
    if (!c.messages.length){
      pushMessage("bot", "Hola üëã Soy FRIJOBOT. ¬øQu√© quieres analizar hoy?");
    }
    renderChatList();
    renderMessages();
    setStatus(false, "Sin conectar");
  })();
</script>
</body>
</html>
