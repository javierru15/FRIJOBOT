<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FRIJOBOT</title>
  <meta name="description" content="FRIJOBOT â€” Asistente inteligente conectado a tu operaciÃ³n." />
  <meta name="theme-color" content="#0B0F14" />

  <style>
    :root{
      /* TraxiÃ³n-ish palette (dark + green accent) */
      --bg0:#070A0D;
      --bg1:#0B0F14;
      --panel:#0E141B;
      --panel2:#0C1117;
      --card: rgba(255,255,255,.04);
      --card2: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.10);
      --border2: rgba(255,255,255,.16);
      --text:#EAF1FF;
      --muted:#9AA7B8;

      --brand:#22C55E;     /* green */
      --brand2:#16A34A;    /* deeper green */
      --warn:#F59E0B;
      --danger:#EF4444;

      --shadow: 0 22px 70px rgba(0,0,0,.50);
      --shadow2: 0 14px 40px rgba(0,0,0,.45);
      --radius: 18px;
      --radius2: 22px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(900px 520px at 15% 15%, rgba(34,197,94,.14), transparent 60%),
        radial-gradient(900px 520px at 85% 10%, rgba(34,197,94,.08), transparent 55%),
        radial-gradient(1000px 700px at 50% 95%, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* Layout */
    .shell{
      width:min(1200px, 100%);
      margin:0 auto;
      padding: 22px 16px 26px;
      display:grid;
      grid-template-columns: 340px 1fr;
      gap: 14px;
      align-items: stretch;
    }

    @media (max-width: 980px){
      .shell{ grid-template-columns: 1fr; }
      .sidebar{ order: 2; }
      .main{ order: 1; }
    }

    /* Top banner */
    .topbar{
      width:min(1200px, 100%);
      margin: 0 auto;
      padding: 18px 16px 0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    }

    .brand{
      display:flex; align-items:center; gap:12px;
      min-width:0;
    }
    .logoWrap{
      width:44px; height:44px;
      border-radius: 14px;
      overflow:hidden;
      background: linear-gradient(135deg, rgba(34,197,94,.25), rgba(255,255,255,.06));
      border: 1px solid rgba(34,197,94,.25);
      box-shadow: 0 14px 40px rgba(34,197,94,.12);
      flex:0 0 auto;
      display:grid;
      place-items:center;
    }
    .logoWrap img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }
    .brandText{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brandText .title{
      font-weight:900;
      letter-spacing:.5px;
      text-transform: uppercase;
      font-size: 14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandText .subtitle{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .rightTop{
      display:flex;
      align-items:center;
      gap:10px;
      flex: 0 0 auto;
    }
    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      font-size: 12px;
      color: var(--muted);
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: var(--danger);
      box-shadow: 0 0 0 4px rgba(239,68,68,.14);
    }
    .dot.ok{
      background: var(--brand);
      box-shadow: 0 0 0 4px rgba(34,197,94,.16);
    }

    .btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 800;
      cursor:pointer;
      transition: .15s transform, .15s background, .15s border;
    }
    .btn:hover{
      background: rgba(255,255,255,.07);
      border-color: rgba(255,255,255,.16);
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(34,197,94,.32);
      background: linear-gradient(135deg, rgba(34,197,94,.18), rgba(255,255,255,.05));
    }

    /* Sidebar */
    .sidebar{
      border-radius: var(--radius2);
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height: 560px;
    }

    .sideHeader{
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(12,17,23,.92), rgba(12,17,23,.60));
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .sideHeader .h{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .sideHeader .h .t{
      font-weight:900;
      letter-spacing:.3px;
      font-size: 13px;
      text-transform: uppercase;
    }
    .sideHeader .h .s{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .sideBody{
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .search{
      width:100%;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 10px 12px;
      color: var(--text);
      outline:none;
      font-size: 13px;
    }

    .chatList{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: 520px;
      overflow:auto;
      padding-right: 4px;
    }

    .chatItem{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 10px 10px;
      cursor:pointer;
      transition: .15s background, .15s border, .15s transform;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .chatItem:hover{
      background: rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.16);
    }
    .chatItem.active{
      border-color: rgba(34,197,94,.32);
      background: linear-gradient(135deg, rgba(34,197,94,.12), rgba(255,255,255,.03));
    }
    .chatItem .meta{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .chatItem .name{
      font-weight:900;
      font-size: 13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chatItem .snippet{
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 240px;
    }
    .chatItem .when{
      font-size:11px;
      color: rgba(154,167,184,.85);
    }
    .miniBtns{
      display:flex;
      flex-direction:column;
      gap:6px;
      flex:0 0 auto;
    }
    .iconBtn{
      width:34px;
      height:34px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      cursor:pointer;
      display:grid;
      place-items:center;
      font-weight:900;
      transition:.15s background,.15s border;
    }
    .iconBtn:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.16);
    }

    /* Main */
    .main{
      border-radius: var(--radius2);
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height: 560px;
      display:grid;
      grid-template-rows: auto 1fr auto;
    }

    .mainHeader{
      padding: 14px 14px 12px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(12,17,23,.92), rgba(12,17,23,.60));
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .mainHeader .left{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .mainHeader .left .t{
      font-weight:900;
      text-transform: uppercase;
      letter-spacing:.35px;
      font-size: 13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .mainHeader .left .s{
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .chatBox{
      padding: 14px;
      overflow:auto;
      background:
        radial-gradient(1200px 700px at 50% 0%, rgba(34,197,94,.06), transparent 55%),
        rgba(10,15,20,.30);
    }

    .msgRow{
      display:flex;
      gap:10px;
      margin: 10px 0;
      align-items:flex-start;
    }
    .avatar{
      width: 36px; height: 36px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      display:grid;
      place-items:center;
      font-weight: 900;
      color: var(--muted);
      flex: 0 0 auto;
      user-select:none;
    }
    .avatar.user{
      border-color: rgba(34,197,94,.22);
      color: #B9F6C9;
      background: rgba(34,197,94,.06);
    }
    .avatar.bot{
      border-color: rgba(255,255,255,.12);
      color: #EAF1FF;
    }
    .bubble{
      max-width: 820px;
      padding: 12px 12px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      white-space:pre-wrap;
      word-break:break-word;
      line-height:1.35;
    }
    .bubble.user{
      border-color: rgba(34,197,94,.20);
      background: rgba(34,197,94,.08);
    }
    .bubble.bot{
      border-color: rgba(255,255,255,.10);
    }
    .time{
      margin-top: 6px;
      font-size: 11px;
      color: rgba(154,167,184,.85);
    }

    .typing{
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    .typing span{
      width:7px; height:7px; border-radius:99px;
      background: rgba(255,255,255,.42);
      animation: bounce 1s infinite ease-in-out;
    }
    .typing span:nth-child(2){ animation-delay:.12s }
    .typing span:nth-child(3){ animation-delay:.24s }
    @keyframes bounce{
      0%,80%,100%{ transform: translateY(0); opacity:.55 }
      40%{ transform: translateY(-6px); opacity:1 }
    }

    .composer{
      padding: 12px 14px 14px;
      border-top: 1px solid var(--border);
      background: linear-gradient(0deg, rgba(12,17,23,.92), rgba(12,17,23,.60));
      display:flex;
      gap: 10px;
      align-items:flex-end;
    }
    textarea{
      width:100%;
      min-height: 46px;
      max-height: 150px;
      resize:none;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 12px 12px;
      outline:none;
      font-size: 14px;
      line-height: 1.25;
    }

    .footNote{
      padding: 10px 14px 12px;
      font-size: 12px;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .codePill{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: #DDE7FF;
    }
    a.link{
      color: #B9F6C9;
      text-decoration:none;
      border-bottom: 1px dashed rgba(185,246,201,.55);
    }
  </style>
</head>

<body>
  <!-- Top bar -->
  <div class="topbar">
    <div class="brand">
      <div class="logoWrap" title="FRIJOBOT">
        <img src="logo.png" alt="Logo FRIJOBOT" onerror="this.style.display='none';"/>
      </div>
      <div class="brandText">
        <div class="title">FRIJOBOT</div>
        <div class="subtitle">Vida en movimiento Â· Asistente para operaciÃ³n y datos</div>
      </div>
    </div>

    <div class="rightTop">
      <div class="pill" title="Estado de conexiÃ³n">
        <span class="dot" id="statusDot"></span>
        <span id="statusText">Sin conectar</span>
      </div>
      <button class="btn" id="newChatBtn">Nuevo chat</button>
      <button class="btn primary" id="clearAllBtn">Limpiar todo</button>
    </div>
  </div>

  <!-- App -->
  <div class="shell">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sideHeader">
        <div class="h">
          <div class="t">Conversaciones</div>
          <div class="s" id="sideSub">Tu historial guardado en este navegador</div>
        </div>
        <button class="iconBtn" id="exportBtn" title="Exportar historial">â¤“</button>
      </div>

      <div class="sideBody">
        <input class="search" id="search" placeholder="Buscar conversaciÃ³n..." />
        <div class="chatList" id="chatList"></div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="mainHeader">
        <div class="left">
          <div class="t" id="chatTitle">Chat</div>
          <div class="s">Tip: Enter envÃ­a Â· Shift+Enter salto de lÃ­nea Â· Webhook <span class="codePill">/webhook/chat</span></div>
        </div>
        <button class="btn" id="clearChatBtn">Limpiar chat</button>
      </div>

      <div class="chatBox" id="chatBox"></div>

      <div class="footNote">
        <div>Evita compartir informaciÃ³n sensible innecesaria.</div>
        <div><a href="#" class="link" id="privacy">Aviso</a></div>
      </div>

      <div class="composer">
        <textarea id="input" placeholder="Escribe tu preguntaâ€¦"></textarea>
        <button class="btn primary" id="sendBtn">Enviar</button>
      </div>
    </main>
  </div>

<script>
  // =========================
  // CONFIG
  // =========================
  const WEBHOOK_URL = "https://auto.mindtrax.io/webhook/chat";

  // =========================
  // Storage model (multi-chat)
  // =========================
  const STORE_KEY = "frijobot_store_v1";

  function uid(){
    return Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function nowStr(){
    const d = new Date();
    return d.toLocaleString([], { day:"2-digit", month:"short", hour:"2-digit", minute:"2-digit" });
  }

  function loadStore(){
    try{
      return JSON.parse(localStorage.getItem(STORE_KEY)) || { activeId: null, chats: [] };
    }catch{
      return { activeId: null, chats: [] };
    }
  }

  function saveStore(store){
    localStorage.setItem(STORE_KEY, JSON.stringify(store));
  }

  function createChat(name="Nueva conversaciÃ³n"){
    return {
      id: uid(),
      name,
      createdAt: Date.now(),
      updatedAt: Date.now(),
      messages: [
        { role: "bot", text: "Hola ðŸ‘‹ Soy FRIJOBOT. Â¿QuÃ© quieres analizar hoy?", ts: Date.now() }
      ]
    };
  }

  // =========================
  // DOM
  // =========================
  const chatList = document.getElementById("chatList");
  const chatBox  = document.getElementById("chatBox");
  const input    = document.getElementById("input");
  const sendBtn  = document.getElementById("sendBtn");
  const clearChatBtn = document.getElementById("clearChatBtn");
  const clearAllBtn  = document.getElementById("clearAllBtn");
  const newChatBtn   = document.getElementById("newChatBtn");
  const exportBtn    = document.getElementById("exportBtn");
  const search       = document.getElementById("search");
  const chatTitle    = document.getElementById("chatTitle");
  const statusDot    = document.getElementById("statusDot");
  const statusText   = document.getElementById("statusText");

  function setStatus(ok, text){
    statusDot.classList.toggle("ok", !!ok);
    statusText.textContent = text;
  }

  function escapeText(t){ return (t ?? "").toString(); }

  function renderMessage(msg){
    const row = document.createElement("div");
    row.className = "msgRow";

    const avatar = document.createElement("div");
    avatar.className = "avatar " + (msg.role === "user" ? "user" : "bot");
    avatar.textContent = msg.role === "user" ? "TÃº" : "F";

    const bubble = document.createElement("div");
    bubble.className = "bubble " + (msg.role === "user" ? "user" : "bot");
    bubble.textContent = escapeText(msg.text);

    const time = document.createElement("div");
    time.className = "time";
    time.textContent = new Date(msg.ts).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});

    const col = document.createElement("div");
    col.appendChild(bubble);
    col.appendChild(time);

    row.appendChild(avatar);
    row.appendChild(col);
    return row;
  }

  function renderTyping(){
    const row = document.createElement("div");
    row.className = "msgRow";

    const avatar = document.createElement("div");
    avatar.className = "avatar bot";
    avatar.textContent = "F";

    const bubble = document.createElement("div");
    bubble.className = "bubble bot";
    bubble.innerHTML = `<span class="typing"><span></span><span></span><span></span></span>`;

    const time = document.createElement("div");
    time.className = "time";
    time.textContent = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});

    const col = document.createElement("div");
    col.appendChild(bubble);
    col.appendChild(time);

    row.appendChild(avatar);
    row.appendChild(col);
    return row;
  }

  function getActiveChat(store){
    return store.chats.find(c => c.id === store.activeId) || null;
  }

  function snippetFromChat(chat){
    const last = chat.messages[chat.messages.length - 1];
    const t = last?.text || "";
    return t.length > 60 ? t.slice(0,60) + "â€¦" : t;
  }

  function renderSidebar(store){
    const q = (search.value || "").trim().toLowerCase();
    chatList.innerHTML = "";

    const chats = [...store.chats].sort((a,b) => b.updatedAt - a.updatedAt)
      .filter(c => !q || c.name.toLowerCase().includes(q) || snippetFromChat(c).toLowerCase().includes(q));

    chats.forEach(chat => {
      const item = document.createElement("div");
      item.className = "chatItem " + (chat.id === store.activeId ? "active" : "");

      const meta = document.createElement("div");
      meta.className = "meta";
      const name = document.createElement("div");
      name.className = "name";
      name.textContent = chat.name;

      const snip = document.createElement("div");
      snip.className = "snippet";
      snip.textContent = snippetFromChat(chat);

      const when = document.createElement("div");
      when.className = "when";
      when.textContent = new Date(chat.updatedAt).toLocaleString([], { day:"2-digit", month:"short", hour:"2-digit", minute:"2-digit" });

      meta.appendChild(name);
      meta.appendChild(snip);
      meta.appendChild(when);

      const mini = document.createElement("div");
      mini.className = "miniBtns";

      const renameBtn = document.createElement("button");
      renameBtn.className = "iconBtn";
      renameBtn.title = "Renombrar";
      renameBtn.textContent = "âœŽ";
      renameBtn.onclick = (e)=>{
        e.stopPropagation();
        const n = prompt("Nombre de la conversaciÃ³n:", chat.name);
        if(n && n.trim()){
          chat.name = n.trim();
          chat.updatedAt = Date.now();
          saveStore(store);
          renderAll(store);
        }
      };

      const delBtn = document.createElement("button");
      delBtn.className = "iconBtn";
      delBtn.title = "Eliminar";
      delBtn.textContent = "ðŸ—‘";
      delBtn.onclick = (e)=>{
        e.stopPropagation();
        if(!confirm("Â¿Eliminar esta conversaciÃ³n?")) return;
        store.chats = store.chats.filter(c => c.id !== chat.id);
        if(store.activeId === chat.id){
          store.activeId = store.chats[0]?.id || null;
        }
        if(!store.activeId && store.chats.length === 0){
          const c = createChat("Chat");
          store.chats.push(c);
          store.activeId = c.id;
        }
        saveStore(store);
        renderAll(store);
      };

      mini.appendChild(renameBtn);
      mini.appendChild(delBtn);

      item.appendChild(meta);
      item.appendChild(mini);

      item.onclick = ()=>{
        store.activeId = chat.id;
        saveStore(store);
        renderAll(store);
      };

      chatList.appendChild(item);
    });
  }

  function renderChat(store){
    const chat = getActiveChat(store);
    chatBox.innerHTML = "";
    if(!chat) return;

    chatTitle.textContent = chat.name;

    chat.messages.forEach(m => {
      chatBox.appendChild(renderMessage(m));
    });
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function renderAll(store){
    renderSidebar(store);
    renderChat(store);
  }

  // =========================
  // Reply extraction (fix JSON printed)
  // =========================
  function extractReply(d){
    if (d && typeof d.reply === "string") return d.reply;
    if (d && typeof d.output === "string") return d.output;
    if (d && typeof d.text === "string") return d.text;
    if (d && typeof d.message === "string") return d.message;

    if (Array.isArray(d) && d[0] && typeof d[0].reply === "string") return d[0].reply;
    if (Array.isArray(d) && d[0] && typeof d[0].output === "string") return d[0].output;
    if (Array.isArray(d) && d[0] && typeof d[0].text === "string") return d[0].text;

    // if n8n returns { data: [...] }
    if (d && d.data && Array.isArray(d.data)){
      const x = d.data[0];
      if (x?.reply) return x.reply;
      if (x?.output) return x.output;
      if (x?.text) return x.text;
    }
    return (typeof d === "string") ? d : JSON.stringify(d);
  }

  // =========================
  // Messaging
  // =========================
  async function send(){
    const text = (input.value || "").trim();
    if(!text) return;

    const store = loadStore();
    const chat = getActiveChat(store);
    if(!chat) return;

    // push user msg
    chat.messages.push({ role:"user", text, ts: Date.now() });
    chat.updatedAt = Date.now();
    input.value = "";
    saveStore(store);
    renderAll(store);

    // typing
    const typingNode = renderTyping();
    chatBox.appendChild(typingNode);
    chatBox.scrollTop = chatBox.scrollHeight;

    try{
      // sessionId per chat
      const sessionId = chat.id;

      const res = await fetch(WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ message: text, sessionId })
      });

      if(!res.ok){
        const t = await res.text();
        throw new Error(`HTTP ${res.status}: ${t}`);
      }

      const data = await res.json();
      const reply = extractReply(data);

      // remove typing node
      typingNode.remove();

      chat.messages.push({ role:"bot", text: reply, ts: Date.now() });
      chat.updatedAt = Date.now();
      saveStore(store);

      setStatus(true, "Conectado");
      renderAll(store);
    }catch(err){
      typingNode.remove();
      chat.messages.push({
        role:"bot",
        text: "âš ï¸ No pude conectar con n8n. Si a veces sÃ­ conecta, casi siempre es CORS o el webhook estÃ¡ en modo test/no activo.",
        ts: Date.now()
      });
      chat.updatedAt = Date.now();
      saveStore(store);

      setStatus(false, "Error");
      renderAll(store);
      console.error(err);
    }
  }

  // =========================
  // Buttons
  // =========================
  sendBtn.addEventListener("click", send);
  input.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });

  clearChatBtn.addEventListener("click", ()=>{
    const store = loadStore();
    const chat = getActiveChat(store);
    if(!chat) return;
    if(!confirm("Â¿Limpiar esta conversaciÃ³n?")) return;

    chat.messages = [{ role:"bot", text:"Listo. Â¿QuÃ© quieres analizar ahora?", ts: Date.now() }];
    chat.updatedAt = Date.now();
    saveStore(store);
    renderAll(store);
  });

  clearAllBtn.addEventListener("click", ()=>{
    if(!confirm("Â¿Borrar TODAS las conversaciones?")) return;
    const store = { activeId: null, chats: [] };
    const c = createChat("Chat");
    store.chats.push(c);
    store.activeId = c.id;
    saveStore(store);
    renderAll(store);
  });

  newChatBtn.addEventListener("click", ()=>{
    const store = loadStore();
    const c = createChat("Chat " + nowStr());
    store.chats.push(c);
    store.activeId = c.id;
    saveStore(store);
    renderAll(store);
  });

  exportBtn.addEventListener("click", ()=>{
    const store = loadStore();
    const blob = new Blob([JSON.stringify(store, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "frijobot_history.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });

  search.addEventListener("input", ()=>{
    const store = loadStore();
    renderSidebar(store);
  });

  document.getElementById("privacy").addEventListener("click", (e)=>{
    e.preventDefault();
    alert("FRIJOBOT procesa tus mensajes para responder con datos. Evita compartir informaciÃ³n sensible si no es necesario.");
  });

  // =========================
  // Init
  // =========================
  (function init(){
    let store = loadStore();
    if(!store.chats || store.chats.length === 0){
      const c = createChat("Chat");
      store = { activeId: c.id, chats: [c] };
      saveStore(store);
    }else if(!store.activeId){
      store.activeId = store.chats[0].id;
      saveStore(store);
    }
    renderAll(store);
    setStatus(false, "Sin conectar");
  })();
</script>
</body>
</html>
